# Uses repo root as build context to access pnpm-lock.yaml
FROM node:20-alpine

RUN npm install -g pnpm@latest

WORKDIR /app

COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./
COPY apps/dashboard/package.json ./apps/dashboard/
COPY packages/reporter/package.json ./packages/reporter/
COPY packages/fixture/package.json ./packages/fixture/
COPY packages/eslint-plugin/package.json ./packages/eslint-plugin/

RUN pnpm install

COPY apps/dashboard ./apps/dashboard

# Next.js writes build cache here during development
RUN mkdir -p /app/apps/dashboard/.next && chown -R node:node /app/apps/dashboard/.next

USER node
WORKDIR /app/apps/dashboard

EXPOSE 3031

CMD ["pnpm", "dev"]
